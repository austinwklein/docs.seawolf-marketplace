name: MkDocs Documentation Deployment

on:
  push:
    branches:
      - main

jobs:
  deploy-docs:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout documentation repository
        uses: actions/checkout@v4

      # Deploy MkDocs site to server
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: deploy-docs
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            # Configuration
            DOCS_DIR=/opt/seawolf-marketplace/docs
            REPO_URL=ssh://git@github.com/${{ github.repository }}.git
            BRANCH=main
            MKDOCS_PROJECT_DIR="$DOCS_DIR/seawolf-marketplace-docs"
            
            echo "=== Deploying documentation ==="
            
            # Create docs directory if it doesn't exist
            mkdir -p "$DOCS_DIR"
            
            # Git operations - clone or update repository
            cd "$DOCS_DIR"
            if [ ! -d .git ]; then
              echo "Cloning repository..."
              git clone -b "$BRANCH" "$REPO_URL" .
            else
              echo "Updating existing repository..."
              git fetch origin
              git checkout -f "$BRANCH"
              git reset --hard origin/"$BRANCH"
            fi
            
            echo "=== Building MkDocs site ==="
            
            # Install/upgrade MkDocs Material if needed
            pip3 install --user --upgrade mkdocs-material
            
            # Navigate to the mkdocs project directory and build
            cd "$MKDOCS_PROJECT_DIR"
            ~/.local/bin/mkdocs build --clean
            
            # Set correct permissions
            echo "=== Setting permissions ==="
            chown -R deploy-docs:deploy-docs "$DOCS_DIR"
            chmod -R 755 "$DOCS_DIR"
            
            # Verification
            echo "=== Deployment verification ==="
            echo "Site directory: $(ls -la $MKDOCS_PROJECT_DIR/site | head -5)"
            echo "Documentation deployed successfully at $(date)"
